/**
 * GithubController
 *
 * @description :: Server-side logic for managing githubs
 * @help        :: See http://links.sailsjs.org/docs/controllers
 */

/**
 * { id: 46512358,
  name: 'hackathon-live',
  full_name: 'Pierre-Gilles/hackathon-live',
  owner: 
   { name: 'Pierre-Gilles',
     email: 'Pierre-Gilles@users.noreply.github.com' },
  private: false,
  html_url: 'https://github.com/Pierre-Gilles/hackathon-live',
  description: 'Hackathon UTC Live screen',
  fork: false,
  url: 'https://github.com/Pierre-Gilles/hackathon-live',
  forks_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/forks',
  keys_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/keys{/key_id}',
  collaborators_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/collaborators{/collaborator}',
  teams_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/teams',
  hooks_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/hooks',
  issue_events_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/issues/events{/number}',
  events_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/events',
  assignees_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/assignees{/user}',
  branches_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/branches{/branch}',
  tags_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/tags',
  blobs_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/blobs{/sha}',
  git_tags_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/tags{/sha}',
  git_refs_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/refs{/sha}',
  trees_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/trees{/sha}',
  statuses_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/statuses/{sha}',
  languages_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/languages',
  stargazers_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/stargazers',
  contributors_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/contributors',
  subscribers_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/subscribers',
  subscription_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/subscription',
  commits_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/commits{/sha}',
  git_commits_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/commits{/sha}',
  comments_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/comments{/number}',
  issue_comment_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/issues/comments{/number}',
  contents_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/contents/{+path}',
  compare_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/compare/{base}...{head}',
  merges_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/merges',
  archive_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/{archive_format}{/ref}',
  downloads_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/downloads',
  issues_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/issues{/number}',
  pulls_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/pulls{/number}',
  milestones_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/milestones{/number}',
  notifications_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/notifications{?since,all,participating}',
  labels_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/labels{/name}',
  releases_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/releases{/id}',
  created_at: 1447958184,
  updated_at: '2015-11-19T18:36:51Z',
  pushed_at: 1447964721,
  git_url: 'git://github.com/Pierre-Gilles/hackathon-live.git',
  ssh_url: 'git@github.com:Pierre-Gilles/hackathon-live.git',
  clone_url: 'https://github.com/Pierre-Gilles/hackathon-live.git',
  svn_url: 'https://github.com/Pierre-Gilles/hackathon-live',
  homepage: null,
  size: 120,
  stargazers_count: 0,
  watchers_count: 0,
  language: 'JavaScript',
  has_issues: true,
  has_downloads: true,
  has_wiki: true,
  has_pages: false,
  forks_count: 0,
  mirror_url: null,
  open_issues_count: 0,
  forks: 0,
  open_issues: 0,
  watchers: 0,
  default_branch: 'master',
  stargazers: 0,
  master_branch: 'master' }
refs/heads/master
{ ref: 'refs/heads/master',
  before: '9bd8d9ff6801b186e6632819ea0270ee8e3736de',
  after: '8ba36845597ab5479a4c9fbb3ec965076e5eca2d',
  created: false,
  deleted: false,
  forced: false,
  base_ref: null,
  compare: 'https://github.com/Pierre-Gilles/hackathon-live/compare/9bd8d9ff6801...8ba36845597a',
  commits: 
   [ { id: 'f42195e5cae450e172598f971f7e8c6b2c4a1842',
       distinct: true,
       message: 'Participant models',
       timestamp: '2015-11-19T21:08:17+01:00',
       url: 'https://github.com/Pierre-Gilles/hackathon-live/commit/f42195e5cae450e172598f971f7e8c6b2c4a1842',
       author: [Object],
       committer: [Object],
       added: [],
       removed: [],
       modified: [Object] },
     { id: '1efae0e7c145bd7a03b1210d740db723d4b9f215',
       distinct: true,
       message: 'Team models',
       timestamp: '2015-11-19T21:08:25+01:00',
       url: 'https://github.com/Pierre-Gilles/hackathon-live/commit/1efae0e7c145bd7a03b1210d740db723d4b9f215',
       author: [Object],
       committer: [Object],
       added: [],
       removed: [],
       modified: [Object] },
     { id: '122e031086586537f95989425ed7be17251c97f1',
       distinct: true,
       message: 'Payload routes for github webhooks',
       timestamp: '2015-11-19T21:08:36+01:00',
       url: 'https://github.com/Pierre-Gilles/hackathon-live/commit/122e031086586537f95989425ed7be17251c97f1',
       author: [Object],
       committer: [Object],
       added: [],
       removed: [],
       modified: [Object] },
     { id: '8ba36845597ab5479a4c9fbb3ec965076e5eca2d',
       distinct: true,
       message: 'score',
       timestamp: '2015-11-19T21:08:56+01:00',
       url: 'https://github.com/Pierre-Gilles/hackathon-live/commit/8ba36845597ab5479a4c9fbb3ec965076e5eca2d',
       author: [Object],
       committer: [Object],
       added: [Object],
       removed: [],
       modified: [] } ],
  head_commit: 
   { id: '8ba36845597ab5479a4c9fbb3ec965076e5eca2d',
     distinct: true,
     message: 'score',
     timestamp: '2015-11-19T21:08:56+01:00',
     url: 'https://github.com/Pierre-Gilles/hackathon-live/commit/8ba36845597ab5479a4c9fbb3ec965076e5eca2d',
     author: 
      { name: 'Pierre-Gilles Leymarie',
        email: 'pierregilles.leymarie@gmail.com',
        username: 'Pierre-Gilles' },
     committer: 
      { name: 'Pierre-Gilles Leymarie',
        email: 'pierregilles.leymarie@gmail.com',
        username: 'Pierre-Gilles' },
     added: [ 'api/models/Score.js' ],
     removed: [],
     modified: [] },
  repository: 
   { id: 46512358,
     name: 'hackathon-live',
     full_name: 'Pierre-Gilles/hackathon-live',
     owner: 
      { name: 'Pierre-Gilles',
        email: 'Pierre-Gilles@users.noreply.github.com' },
     private: false,
     html_url: 'https://github.com/Pierre-Gilles/hackathon-live',
     description: 'Hackathon UTC Live screen',
     fork: false,
     url: 'https://github.com/Pierre-Gilles/hackathon-live',
     forks_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/forks',
     keys_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/keys{/key_id}',
     collaborators_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/collaborators{/collaborator}',
     teams_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/teams',
     hooks_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/hooks',
     issue_events_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/issues/events{/number}',
     events_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/events',
     assignees_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/assignees{/user}',
     branches_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/branches{/branch}',
     tags_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/tags',
     blobs_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/blobs{/sha}',
     git_tags_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/tags{/sha}',
     git_refs_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/refs{/sha}',
     trees_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/trees{/sha}',
     statuses_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/statuses/{sha}',
     languages_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/languages',
     stargazers_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/stargazers',
     contributors_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/contributors',
     subscribers_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/subscribers',
     subscription_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/subscription',
     commits_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/commits{/sha}',
     git_commits_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/git/commits{/sha}',
     comments_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/comments{/number}',
     issue_comment_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/issues/comments{/number}',
     contents_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/contents/{+path}',
     compare_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/compare/{base}...{head}',
     merges_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/merges',
     archive_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/{archive_format}{/ref}',
     downloads_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/downloads',
     issues_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/issues{/number}',
     pulls_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/pulls{/number}',
     milestones_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/milestones{/number}',
     notifications_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/notifications{?since,all,participating}',
     labels_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/labels{/name}',
     releases_url: 'https://api.github.com/repos/Pierre-Gilles/hackathon-live/releases{/id}',
     created_at: 1447958184,
     updated_at: '2015-11-19T18:36:51Z',
     pushed_at: 1447964721,
     git_url: 'git://github.com/Pierre-Gilles/hackathon-live.git',
     ssh_url: 'git@github.com:Pierre-Gilles/hackathon-live.git',
     clone_url: 'https://github.com/Pierre-Gilles/hackathon-live.git',
     svn_url: 'https://github.com/Pierre-Gilles/hackathon-live',
     homepage: null,
     size: 120,
     stargazers_count: 0,
     watchers_count: 0,
     language: 'JavaScript',
     has_issues: true,
     has_downloads: true,
     has_wiki: true,
     has_pages: false,
     forks_count: 0,
     mirror_url: null,
     open_issues_count: 0,
     forks: 0,
     open_issues: 0,
     watchers: 0,
     default_branch: 'master',
     stargazers: 0,
     master_branch: 'master' },
  pusher: 
   { name: 'Pierre-Gilles',
     email: 'Pierre-Gilles@users.noreply.github.com' },
  sender: 
   { login: 'Pierre-Gilles',
     id: 7365207,
     avatar_url: 'https://avatars.githubusercontent.com/u/7365207?v=3',
     gravatar_id: '',
     url: 'https://api.github.com/users/Pierre-Gilles',
     html_url: 'https://github.com/Pierre-Gilles',
     followers_url: 'https://api.github.com/users/Pierre-Gilles/followers',
     following_url: 'https://api.github.com/users/Pierre-Gilles/following{/other_user}',
     gists_url: 'https://api.github.com/users/Pierre-Gilles/gists{/gist_id}',
     starred_url: 'https://api.github.com/users/Pierre-Gilles/starred{/owner}{/repo}',
     subscriptions_url: 'https://api.github.com/users/Pierre-Gilles/subscriptions',
     organizations_url: 'https://api.github.com/users/Pierre-Gilles/orgs',
     repos_url: 'https://api.github.com/users/Pierre-Gilles/repos',
     events_url: 'https://api.github.com/users/Pierre-Gilles/events{/privacy}',
     received_events_url: 'https://api.github.com/users/Pierre-Gilles/received_events',
     type: 'User',
     site_admin: false } }
	 
	 **/
module.exports = {
	
	hooks: function(req, res) {
		
		var repository = req.param('repository');
    GithubService.getNbOfCommits(repository.owner.name, repository.name, function(err, points){
        if(err){
          return res.status(500).json(err);
        } else {
          TeamService.updateTeamScore(repository.full_name, points, function(err, score ){
              if(err) return res.status(500).json(err);
              
              // send a broadcast message to all connected clients
              sails.sockets.blast('newScore', score);
              
              return res.json(score)
          });
        }
    });
	},
  
  refresh: function(req, res){
      var repository = req.param('repository');
      var repo = repository.split('/');
      
      GithubService.getNbOfCommits(repo[0], repo[1], function(err, points){
        if(err){
          return res.status(500).json(err);
        } else {
          TeamService.updateTeamScore(repository, points, function(err, score ){
              if(err) return res.status(500).json(err);
              
              // send a broadcast message to all connected clients
              sails.sockets.blast('newScore', score);
              
              return res.json(score)
          });
        }
    });
  }
	
};

